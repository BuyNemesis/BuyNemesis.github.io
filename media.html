<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemesis Media - Gameplay Clips</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow-x: hidden;
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(232, 187, 249, 0.08) 0%, transparent 50%);
            animation: floatGradient 25s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes floatGradient {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(20%, 15%) scale(1.1); }
            66% { transform: translate(-15%, 20%) scale(0.95); }
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(232, 187, 249, 0.1);
            padding: 20px 24px; /* match index spacing */
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 0;
        }

        .nav-brand {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: #E8BBF9;
            text-shadow: 0 0 20px rgba(232, 187, 249, 0.5);
            text-decoration: none;
            margin-left: 0;
            padding-left: 0;
        }

        /* nav button/link styles */
        .nav-links { display:flex; gap:22px; align-items:center; margin-left:auto; margin-right:0; }
        .nav-btn { color: rgba(255,255,255,0.7); text-decoration:none; font-weight:500; font-size:13px; letter-spacing:0.6px; text-transform:uppercase; transition: all 0.2s; }
        .nav-btn::after { display: none !important; }
        .nav-btn:hover { color: #E8BBF9; }
        .nav-back {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
        }

        .nav-back:hover {
            color: #E8BBF9;
        }

        @media (max-width: 768px) {
            .navbar { flex-wrap: wrap; padding: 12px 20px; }
            .nav-brand { margin-left: 0; order: 1; width: 100%; text-align: left; padding-left: 0; }
            .nav-links { margin-left: 0; order: 2; width: 100%; justify-content: flex-start; gap: 14px; padding-top: 8px; }
        }

        /* Main Container */
        .media-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 120px 40px 60px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 4rem;
        }

        .page-title {
            font-family: 'Outfit', sans-serif;
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 600;
            color: #fff;
            margin-bottom: 1rem;
            text-shadow: 0 0 30px rgba(232, 187, 249, 0.5);
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 0.5px;
        }

        /* Video Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        /* Tabs */
        .tab-btn {
            background: transparent;
            border: 1px solid rgba(232,187,249,0.12);
            color: rgba(255,255,255,0.8);
            padding: 8px 16px;
            margin: 0 6px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.18s ease;
        }
        .tab-btn[aria-pressed="true"] {
            background: linear-gradient(135deg, #E8BBF9, #C38EE1);
            color: #000;
            border-color: transparent;
            box-shadow: 0 6px 22px rgba(142,87,181,0.18);
        }

        .video-card {
            background: #0a0a0a;
            border: 1px solid rgba(232, 187, 249, 0.15);
            border-radius: 8px;
            overflow: hidden; /* keep rounded corners clipped */
            transition: all 0.3s ease;
            position: relative;
            z-index: 0; /* base stacking context */
        }

        .video-card::before,
        .video-card::after {
            display: none !important;
        }

        .video-card:hover {
            border-color: rgba(232, 187, 249, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(232, 187, 249, 0.2);
            z-index: 1; /* Keep card effects below video */
        }
        
        .video-card:hover::before,
        .video-card:hover::after {
            display: none !important;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background: #000;
            z-index: 2; /* sit above card background but inside card clipping */
            isolation: isolate;
            border-radius: 8px 8px 0 0; /* rounded top corners only */
            overflow: hidden; /* Clip video to rounded top corners */
        }

        .video-wrapper::before,
        .video-wrapper::after {
            display: none !important;
        }

        .video-wrapper iframe,
        .video-wrapper video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            pointer-events: auto;
            z-index: 100; /* Very high z-index to be on top of everything */
        }

        .video-wrapper video {
            background: #000;
            filter: none !important;
            opacity: 1 !important;
            z-index: 3; /* ensure video is above wrapper decorations */
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .video-wrapper:hover video {
            filter: none !important;
            opacity: 1 !important;
        }

        .video-wrapper {
            user-select: none;
            -webkit-user-select: none;
        }

        .video-card {
            user-select: none;
            -webkit-user-select: none;
        }

        .video-wrapper video::-webkit-media-controls-panel {
            background: rgba(10, 10, 10, 0.9);
        }

        /* Remove any overlay effects on hover */
        .video-card:hover .video-wrapper::before,
        .video-card:hover .video-wrapper::after {
            display: none;
        }

        .video-wrapper::before,
        .video-wrapper::after {
            display: none;
        }

        /* Prevent video from darkening on hover */
        .video-card:hover video,
        .video-card:hover iframe,
        video:hover,
        video:focus {
            opacity: 1 !important;
            filter: none !important;
            background: #000 !important;
            box-shadow: none !important;
        }

        .video-wrapper:hover video,
        .video-wrapper:hover iframe {
            opacity: 1 !important;
            filter: none !important;
            background: #000 !important;
        }
        
        /* Absolutely no overlays or pseudo-elements on video */
        video::before,
        video::after,
        video:hover::before,
        video:hover::after {
            content: none !important;
            display: none !important;
        }

        /* Remove browser default video overlay - ALL WEBKIT CONTROLS */
        video::-webkit-media-controls-overlay-enclosure {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }

        video::-webkit-media-controls-enclosure {
            background: transparent !important;
            background-color: transparent !important;
        }

        video::-webkit-media-controls-overlay-play-button {
            display: none !important;
            opacity: 0 !important;
        }

        /* Remove the scrim/gradient overlay */
        video::-webkit-media-controls {
            filter: none !important;
            background: none !important;
        }

        /* Specifically target and disable all overlays on MP4 videos */
        video[src*="discord"],
        video source[src*="discord"] {
            background: #000 !important;
        }

        video::-webkit-media-controls-timeline,
        video::-webkit-media-controls-current-time-display,
        video::-webkit-media-controls-time-remaining-display {
            background: transparent !important;
        }

        /* Prevent darkening in fullscreen */
        video:fullscreen,
        video:-webkit-full-screen,
        video:-moz-full-screen {
            background: #000 !important;
        }

        video:fullscreen::-webkit-media-controls-overlay-enclosure,
        video:-webkit-full-screen::-webkit-media-controls-overlay-enclosure {
            display: none !important;
            opacity: 0 !important;
        }

        /* Force remove any gradient overlays */
        video::before,
        video::after {
            display: none !important;
            content: none !important;
        }

        /* Remove control bar gradient */
        video::-webkit-media-controls-panel {
            background-image: none !important;
        }

        .video-info {
            padding: 1.5rem;
            position: relative;
            z-index: 1; /* below video but above card background */
            background: #0a0a0a; /* Ensure solid background */
            border-radius: 0 0 8px 8px; /* rounded bottom corners to match card */
        }

        .video-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .video-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .video-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .video-date {
            color: rgba(255, 255, 255, 0.4);
        }

        /* Loading State */
        .loading-container {
            text-align: center;
            padding: 4rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(232, 187, 249, 0.2);
            border-top: 3px solid #E8BBF9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
            letter-spacing: 0.5px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Load More Button */
        .load-more-container {
            text-align: center;
            margin-top: 3rem;
        }

        .load-more-btn {
            background: transparent;
            border: 1px solid rgba(232, 187, 249, 0.3);
            color: rgba(232, 187, 249, 0.8);
            padding: 1rem 2.5rem;
            font-size: 0.9rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .load-more-btn:hover {
            background: rgba(232, 187, 249, 0.1);
            border-color: rgba(232, 187, 249, 0.6);
            color: #E8BBF9;
        }

        .load-more-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .media-container {
                padding: 100px 20px 40px;
            }

            .video-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .nav-container {
                padding: 0 20px;
            }
        }

        /* Fade in animation */
        .video-card {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Custom lightweight overlay to avoid native browser scrim */
        .video-overlay-play {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            color: rgba(255,255,255,0.9);
            pointer-events: none; /* allow clicks to pass to video */
            transition: opacity 0.15s ease;
            opacity: 0.85;
            z-index: 200; /* above video */
            text-shadow: 0 4px 18px rgba(0,0,0,0.6);
        }
        .video-wrapper { position: relative; }
        .mp4-video { z-index: 100; position: relative; }
        .video-overlay-play.hidden { opacity: 0; visibility: hidden; }
        /* Modal (in-page enlarged view) */
        .media-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            padding: 40px;
        }
        .media-modal.open { display: flex; }
        .media-modal .modal-inner {
            width: min(1200px, 95%);
            max-height: 90%;
            background: #0b0b0b;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
        }
        /* Reserve space for caption/close chrome when sizing media */
        .modal-media-area { flex: 1 1 auto; position: relative; background: #000; display:flex; align-items:center; justify-content:center; }
        /* Calculate available max height for media inside modal to avoid zooming on tall images */
        .modal-media-area iframe,
        .modal-media-area video,
        .modal-media-area img {
            max-width: calc(95vw - 40px);
            max-height: calc(90vh - 120px); /* account for modal chrome + caption */
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            transform: none !important;
        }
        /* Fit mode helpers: default to width; fit-height will allow tall images to scale to height */
        .modal-media-area.fit-height img,
        .modal-media-area.fit-height video {
            max-height: calc(90vh - 120px);
            width: auto !important;
            height: auto !important;
        }
        .modal-media-area.fit-width img,
        .modal-media-area.fit-width video {
            max-width: calc(95vw - 40px);
            width: auto !important;
            height: auto !important;
        }
        /* Responsive iframe wrapper for third-party embeds (Streamable, etc.) */
        .iframe-wrapper {
            width: 100%;
            max-width: calc(95vw - 40px);
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
        }
        .iframe-wrapper iframe {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }
        /* Ensure images don't get forced to fill container */
        .modal-media-area img { image-rendering: auto; }
    .modal-close { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); color: #fff; padding: 8px 10px; border-radius: 8px; cursor: pointer; z-index: 2010; }
    .modal-controls { position: absolute; top: 12px; left: 12px; display: flex; gap: 8px; z-index: 2010; }
    .modal-fit-toggle, .modal-unmute { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); color: #E8BBF9; padding: 8px 10px; border-radius: 8px; cursor: pointer; font-weight:600; }
    .modal-fit-toggle[aria-pressed="true"] { background: rgba(232,187,249,0.12); color: #fff; }
    .modal-unmute { color: #fff; }
    .modal-caption { padding: 14px 18px; color: rgba(255,255,255,0.9); font-size: 1rem; border-top: 1px solid rgba(255,255,255,0.03); }

        /* Small fullscreen control inside each card (bottom-right) */
        .card-fullscreen-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.06);
            color: #E8BBF9;
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 300;
            font-weight: 700;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="nav-brand">nemesis</a>
        <div class="nav-links">
            <a href="#features" class="nav-btn">Features</a>
            <a href="media.html" class="nav-btn">Media</a>
            <a href="patchnotes.html" class="nav-btn">Patchnotes</a>
            <a href="#screenshots" class="nav-btn">Demos</a>
            <a href="#faq" class="nav-btn">FAQ</a>
            <a href="#buy" class="nav-btn">Buy</a>
        </div>
    </nav>

    <div class="media-container">
        <div class="page-header">
            <h1 class="page-title">Media Gallery</h1>
            <p class="page-subtitle">Watch nemesis in action - gameplay clips from our community</p>
        </div>

        <div style="text-align:center; margin-bottom: 24px;">
            <button id="tab-videos" class="tab-btn" aria-pressed="true">Videos</button>
            <button id="tab-photos" class="tab-btn" aria-pressed="false">Photos</button>
        </div>

        <div id="video-grid" class="video-grid">
            <!-- Loading state -->
            <div class="loading-container" id="loading">
                <div class="loading-spinner"></div>
                <p class="loading-text">Loading clips...</p>
            </div>
        </div>

        <div class="load-more-container" id="load-more-container" style="display: none;">
            <button class="load-more-btn" id="load-more-btn" onclick="loadMoreVideos()">Load More</button>
        </div>
    </div>

    <script>
    // This will be updated to fetch from backend API
    // For now, using placeholder data structure
    let allVideos = [];
    let allPhotos = [];
    let displayedCount = 0;
    const itemsPerPage = 9;
    let activeTab = 'videos'; // 'videos' or 'photos'

        // Fetch videos from backend API
        async function fetchMediaFromDiscord() {
            try {
                // Replace with your actual Render backend URL
                const API_URL = 'https://nemesis-backend-yv3w.onrender.com/api/media';
                
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                // Expecting shape: { videos: [...], photos: [...] }
                return data;
            } catch (error) {
                console.error('Error fetching videos from API:', error);
                throw error;
            }
        }

        // Utility to escape HTML attributes (placed before card templates to avoid reference errors)
        function escapeHtml(str) {
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

    function createVideoCard(video) {
            let videoContent = '';
            
            if (video.type === 'mp4' && video.videoUrl) {
                // Use a custom control overlay instead of native controls to avoid browser scrim/overlay
                // We intentionally DO NOT include the native `controls` attribute.
                videoContent = `
                    <video 
                        class="mp4-video"
                        preload="metadata" 
                        playsinline
                        disablepictureinpicture
                        style="width: 100%; height: 100%; object-fit: contain; background: #000;"
                        onloadedmetadata="this.volume = 1.0;"
                        onerror="console.error('Video error:', this.error);">
                        <source src="${video.videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="video-overlay-play" aria-hidden="true">▶</div>
                `;
            } else if (video.type === 'streamable' && video.streamableId) {
                // Streamable embed
                videoContent = `<iframe src="https://streamable.com/e/${video.streamableId}" frameborder="0" allowfullscreen allow="autoplay"></iframe>`;
            } else {
                videoContent = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.3);">Video Unavailable</div>`;
            }

            return `
                <div class="video-card">
                    <div class="video-wrapper">
                        ${videoContent}
                        <button class="card-fullscreen-btn" data-type="video" data-src="${video.type === 'mp4' ? video.videoUrl : (video.streamableId ? 'https://streamable.com/e/' + video.streamableId : '')}" data-title="${escapeHtml(video.title || 'Nemesis Gameplay')}">⤢</button>
                    </div>
                    <div class="video-info">
                        <h3 class="video-title">${video.title || 'Nemesis Gameplay'}</h3>
                        <div class="video-meta">
                            ${video.author ? `<span class="video-author">👤 ${video.author}</span>` : ''}
                            ${video.date ? `<span class="video-date">${formatDate(video.date)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function createPhotoCard(photo) {
            return `
                <div class="video-card">
                    <div class="video-wrapper" style="padding-bottom:66%;">
                        <img src="${photo.imageUrl}" alt="${photo.title || 'Screenshot'}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;" />
                        <button class="card-fullscreen-btn" data-type="photo" data-src="${photo.imageUrl}" data-title="${escapeHtml(photo.title || 'Screenshot')}">⤢</button>
                    </div>
                    <div class="video-info">
                        <h3 class="video-title">${photo.title || 'Screenshot'}</h3>
                        <div class="video-meta">
                            ${photo.author ? `<span class="video-author">👤 ${photo.author}</span>` : ''}
                            ${photo.date ? `<span class="video-date">${formatDate(photo.date)}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        function displayItems() {
            const grid = document.getElementById('video-grid');
            const loadMoreContainer = document.getElementById('load-more-container');
            let items = activeTab === 'videos' ? allVideos : allPhotos;

            if (!items || items.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📁</div>
                        <p>No items available yet. Check back soon!</p>
                    </div>
                `;
                loadMoreContainer.style.display = 'none';
                return;
            }

            const toShow = items.slice(0, displayedCount + itemsPerPage);
            displayedCount = toShow.length;

            if (activeTab === 'videos') {
                grid.innerHTML = toShow.map(video => createVideoCard(video)).join('');
                attachCustomVideoControls();
            } else {
                grid.innerHTML = toShow.map(photo => createPhotoCard(photo)).join('');
            }

            // Show/hide load more button
            if (displayedCount < items.length) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        function loadMoreVideos() {
            displayItems();
        }

        async function initializeMediaPage() {
            try {
                const data = await fetchMediaFromDiscord();
                // accept both { videos: [], photos: [] } and legacy array of videos
                if (Array.isArray(data)) {
                    allVideos = data;
                    allPhotos = [];
                } else {
                    allVideos = data.videos || [];
                    allPhotos = data.photos || [];
                }

                // default state
                activeTab = 'videos';
                displayedCount = 0;
                setActiveTabUI();
                displayItems();

                // Enable audio on all video elements after they're loaded
                setTimeout(() => {
                    document.querySelectorAll('video').forEach(video => {
                        video.volume = 1.0;
                        video.muted = false;
                        video.addEventListener('loadedmetadata', () => {
                            console.log('Video loaded:', video.src);
                        });
                    });
                }, 500);
            } catch (error) {
                console.error('Error loading media:', error);
                const grid = document.getElementById('video-grid');
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⚠️</div>
                        <p>Failed to load media. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeMediaPage();

            // Tab buttons
            document.getElementById('tab-videos').addEventListener('click', () => {
                if (activeTab === 'videos') return;
                activeTab = 'videos';
                displayedCount = 0;
                setActiveTabUI();
                displayItems();
            });
            document.getElementById('tab-photos').addEventListener('click', () => {
                if (activeTab === 'photos') return;
                activeTab = 'photos';
                displayedCount = 0;
                setActiveTabUI();
                displayItems();
            });
        });

        function setActiveTabUI() {
            document.getElementById('tab-videos').setAttribute('aria-pressed', activeTab === 'videos');
            document.getElementById('tab-photos').setAttribute('aria-pressed', activeTab === 'photos');
        }

        // Custom controls: attach lightweight overlay and click handlers to MP4 videos
        function attachCustomVideoControls() {
            document.querySelectorAll('.video-wrapper').forEach(wrapper => {
                const video = wrapper.querySelector('video.mp4-video');
                const overlay = wrapper.querySelector('.video-overlay-play');
                if (!video || !overlay) return;

                // Ensure overlay sits above video but doesn't block clicks
                overlay.style.pointerEvents = 'none';

                // Click toggles play/pause
                wrapper.addEventListener('click', (e) => {
                    // Ignore clicks originating from native controls area (if any)
                    if (video.paused) {
                        video.play().catch(err => console.warn('Autoplay blocked', err));
                    } else {
                        video.pause();
                    }
                });

                // Update overlay visibility based on play state
                function updateOverlay() {
                    if (video.paused) {
                        overlay.classList.remove('hidden');
                    } else {
                        overlay.classList.add('hidden');
                    }
                }

                video.addEventListener('play', updateOverlay);
                video.addEventListener('pause', updateOverlay);
                video.addEventListener('loadeddata', updateOverlay);

                // Hide overlay on mousemove when playing
                wrapper.addEventListener('mousemove', () => {
                    if (!video.paused) overlay.classList.add('hidden');
                });

                // Show overlay briefly on mouseleave if paused
                wrapper.addEventListener('mouseleave', () => {
                    if (video.paused) overlay.classList.remove('hidden');
                });

                // Initial state
                updateOverlay();
            });
        }

        // Utility to escape HTML attributes
        function escapeHtml(str) {
            return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // Modal handling (in-page enlarged view)
        function openModal({ type, src, title }) {
            const modal = document.getElementById('media-modal');
            const inner = modal.querySelector('.modal-inner');
            const mediaArea = modal.querySelector('.modal-media-area');
            const caption = modal.querySelector('.modal-caption');

            // Clear previous
            mediaArea.innerHTML = '';
            caption.textContent = title || '';

            if (type === 'photo') {
                const img = document.createElement('img');
                img.src = src;
                img.alt = title || '';
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.width = 'auto';
                img.style.height = 'auto';
                img.style.objectFit = 'contain';
                mediaArea.appendChild(img);
                // If the image is very tall, scale it down to available modal height
                img.onload = () => {
                    const maxH = (window.innerHeight * 0.9) - 120; // matches CSS calc
                    if (img.naturalHeight > maxH) {
                        img.style.maxHeight = maxH + 'px';
                        img.style.width = 'auto';
                    }
                };
            } else if (type === 'video') {
                        // For direct MP4, use video element; for streamable use iframe
                        if (src.includes('streamable.com')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'iframe-wrapper';
                    const iframe = document.createElement('iframe');
                    iframe.src = src;
                    iframe.setAttribute('allowfullscreen', '');
                    iframe.style.border = 'none';
                    wrapper.appendChild(iframe);
                    mediaArea.appendChild(wrapper);
                            // Ensure unmute button is hidden for embeds
                            const unmuteBtn = modal.querySelector('.modal-unmute');
                            if (unmuteBtn) { unmuteBtn.style.display = 'none'; unmuteBtn.setAttribute('aria-hidden','true'); }
                } else {
                    const video = document.createElement('video');
                    video.src = src;
                    video.controls = true;
                    video.autoplay = false;
                    video.playsInline = true;
                    video.preload = 'metadata';
                    video.style.maxWidth = '100%';
                    video.style.maxHeight = '100%';
                    video.style.width = 'auto';
                    video.style.height = 'auto';
                    video.style.background = '#000';
                    mediaArea.appendChild(video);
                            // Start muted to improve autoplay success; provide on-screen Unmute
                            try { video.muted = true; } catch(e){}
                            const unmuteBtn = modal.querySelector('.modal-unmute');
                            if (unmuteBtn) {
                                unmuteBtn.style.display = '';
                                unmuteBtn.setAttribute('aria-hidden','false');
                                unmuteBtn.onclick = () => { try { video.muted = false; } catch(e){}; unmuteBtn.style.display = 'none'; };
                            }
                            // Try to play the video — click that opened modal counts as user gesture in most browsers
                            setTimeout(() => {
                                try { video.play().catch(()=>{}); } catch(e){}
                            }, 50);
                }
            }

            modal.classList.add('open');

            // Close bindings
            modal.querySelector('.modal-close').onclick = closeModal;
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };
            document.addEventListener('keydown', modalKeyHandler);
                // Fit toggle wiring
                const fitToggle = modal.querySelector('.modal-fit-toggle');
                if (fitToggle) {
                    fitToggle.onclick = () => {
                        const pressed = fitToggle.getAttribute('aria-pressed') === 'true';
                        fitToggle.setAttribute('aria-pressed', String(!pressed));
                        const mediaAreaEl = modal.querySelector('.modal-media-area');
                        if (!pressed) {
                            // Switch to fit-height
                            fitToggle.textContent = 'Fit: Height';
                            mediaAreaEl.classList.add('fit-height');
                            mediaAreaEl.classList.remove('fit-width');
                        } else {
                            // Switch to fit-width
                            fitToggle.textContent = 'Fit: Width';
                            mediaAreaEl.classList.add('fit-width');
                            mediaAreaEl.classList.remove('fit-height');
                        }
                    };
                }
        }

        function closeModal() {
            const modal = document.getElementById('media-modal');
            modal.classList.remove('open');
            const mediaArea = modal.querySelector('.modal-media-area');
            // Pause/unload any playing media
            const vid = mediaArea.querySelector('video');
            if (vid) {
                try { vid.pause(); } catch(e){}
                try { vid.removeAttribute('src'); vid.load(); } catch(e){}
            }
            // Remove iframe src to stop playback
            const ifr = mediaArea.querySelector('iframe');
            if (ifr) { try { ifr.src = 'about:blank'; } catch(e){} }
            mediaArea.innerHTML = '';
            // reset modal controls
            const fitToggle = modal.querySelector('.modal-fit-toggle');
            if (fitToggle) { fitToggle.setAttribute('aria-pressed', 'false'); fitToggle.textContent = 'Fit: Width'; }
            const unmuteBtn = modal.querySelector('.modal-unmute');
            if (unmuteBtn) { unmuteBtn.style.display = 'none'; unmuteBtn.setAttribute('aria-hidden','true'); }
            modal.querySelector('.modal-media-area').classList.remove('fit-height','fit-width');
            document.removeEventListener('keydown', modalKeyHandler);
        }

        function modalKeyHandler(e) {
            if (e.key === 'Escape') closeModal();
        }

        // Delegate click for fullscreen buttons (safe check for e.target.closest)
        document.addEventListener('click', (e) => {
            const tgt = e.target;
            if (!tgt || typeof tgt.closest !== 'function') return;
            const btn = tgt.closest('.card-fullscreen-btn');
            if (!btn) return;
            const type = btn.getAttribute('data-type');
            const src = btn.getAttribute('data-src');
            const title = btn.getAttribute('data-title');
            openModal({ type, src, title });
        });

        // Inject modal markup at end of body immediately (or on DOMContentLoaded if body not ready)
        (function insertModal() {
            const html = `
                <div id="media-modal" class="media-modal" role="dialog" aria-modal="true" aria-hidden="true">
                    <div class="modal-inner">
                        <button class="modal-close" aria-label="Close">✕</button>
                        <div class="modal-controls">
                          <button class="modal-fit-toggle" aria-pressed="false" title="Toggle fit mode">Fit: Width</button>
                          <button class="modal-unmute" aria-hidden="true" style="display:none;">Unmute</button>
                        </div>
                        <div class="modal-media-area"></div>
                        <div class="modal-caption"></div>
                    </div>
                </div>
            `;
            if (document.body) {
                document.body.insertAdjacentHTML('beforeend', html);
            } else {
                document.addEventListener('DOMContentLoaded', () => document.body.insertAdjacentHTML('beforeend', html));
            }
        })();
    </script>
</body>
</html>
